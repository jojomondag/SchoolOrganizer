<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SchoolOrganizer.ViewModels"
             xmlns:models="using:SchoolOrganizer.Models"
             xmlns:views="using:SchoolOrganizer.Views"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="SchoolOrganizer.Views.StudentGalleryView"
             x:DataType="vm:StudentGalleryViewModel"
             x:Name="GalleryView">

  <UserControl.Resources>
    <views:UniversalImageConverter x:Key="UniversalImageConverter"/>
    <views:StringIsNullOrWhiteSpaceConverter x:Key="IsNullOrWhiteSpace"/>
    <views:StudentSelectionBrushConverter x:Key="StudentSelectionBrushConverter"/>
    <ControlTemplate x:Key="FlatButtonTemplate">
      <Border Background="{TemplateBinding Background}"
              BorderBrush="{TemplateBinding BorderBrush}"
              BorderThickness="{TemplateBinding BorderThickness}"
              CornerRadius="{TemplateBinding CornerRadius}">
        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                          Content="{TemplateBinding Content}"
                          ContentTemplate="{TemplateBinding ContentTemplate}"/>
      </Border>
    </ControlTemplate>
  </UserControl.Resources>
  <Design.DataContext>
    <vm:StudentGalleryViewModel/>
  </Design.DataContext>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Header and Filters -->
    <Border Grid.Row="0" Background="#f5f5f5" Padding="20">
      <StackPanel>
        <TextBlock Text="Student Gallery" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>
        
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>

          <!-- Search Box -->
          <TextBox Grid.Column="0" 
                   Text="{Binding SearchText}" 
                   Watermark="Search students..." 
                   Margin="0,0,10,0"/>

          <!-- Add Student Button -->
          <Button Grid.Column="1" 
                  Content="Add Student" 
                  Command="{Binding AddStudentCommand}"
                  Background="#27ae60"
                  Foreground="White"
                  Padding="15,5"/>
        </Grid>
      </StackPanel>
    </Border>

    <!-- Student Gallery -->
    <ScrollViewer Grid.Row="1" 
                  Padding="20" 
                  VerticalScrollBarVisibility="Auto" 
                  HorizontalScrollBarVisibility="Disabled"
                  VerticalAlignment="Stretch">
      <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch" MinHeight="400">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <!-- Background button for deselection -->
        <Button Background="Transparent"
                BorderThickness="0"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                Command="{Binding DeselectStudentCommand}"
                Cursor="Arrow"
                Grid.RowSpan="2"
                Template="{StaticResource FlatButtonTemplate}">
          <Button.Styles>
            <Style Selector="Button:pointerover">
              <Setter Property="Background" Value="Transparent"/>
            </Style>
            <Style Selector="Button:pressed">
              <Setter Property="Background" Value="Transparent"/>
            </Style>
          </Button.Styles>
        </Button>
        
        <!-- Loading Indicator -->
        <Border IsVisible="{Binding IsLoading}" 
                Background="#80FFFFFF" 
                HorizontalAlignment="Stretch" 
                VerticalAlignment="Stretch"
                Grid.RowSpan="2">
          <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
            <TextBlock Text="Loading students..." FontSize="16" HorizontalAlignment="Center"/>
          </StackPanel>
        </Border>

        <!-- Students Grid -->
        <ItemsControl x:Name="ProfileCards" 
                      Grid.Row="0"
                      ItemsSource="{Binding Students}" 
                      IsVisible="{Binding !IsLoading}"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Top"
                      Margin="0,0,0,20">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <WrapPanel x:Name="CardsWrapPanel"
                         Orientation="Horizontal" 
                         HorizontalAlignment="Center"/>
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>

          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:Student">
              <Border x:Name="StudentCard"
                      Background="White" 
                      CornerRadius="8" 
                      Margin="12" 
                      Padding="0"
                      BoxShadow="0 2 8 0 #20000000"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Top"
                      Cursor="Hand"
                      BorderThickness="2">
                <Border.BorderBrush>
                  <MultiBinding Converter="{StaticResource StudentSelectionBrushConverter}">
                    <Binding Path="$parent[UserControl].((vm:StudentGalleryViewModel)DataContext).SelectedStudent"/>
                    <Binding Path="."/>
                  </MultiBinding>
                </Border.BorderBrush>

                <!-- Clickable area for the entire card (fills entire border) -->
                <Button Command="{Binding $parent[ItemsControl].((vm:StudentGalleryViewModel)DataContext).SelectStudentCommand}"
                        CommandParameter="{Binding}"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="20,15"
                        Cursor="Hand"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        Name="CardButton"
                        Template="{StaticResource FlatButtonTemplate}">
                  <Button.Styles>
                    <Style Selector="Button:pointerover">
                      <Setter Property="Background" Value="Transparent"/>
                    </Style>
                    <Style Selector="Button:pressed">
                      <Setter Property="Background" Value="Transparent"/>
                    </Style>
                  </Button.Styles>
                    
                    <Grid x:Name="CardContent">
                        <!-- Card Content -->
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Top">
                            <!-- Student Image -->
                            <Grid x:Name="ImageContainer" 
                                  Margin="0,8,0,15" 
                                  HorizontalAlignment="Center">
                                <Border x:Name="ImageBorder" 
                                        ClipToBounds="True" 
                                        Background="#EEE">
                                    <Grid>
                                        <Image Source="{Binding PictureUrl, Converter={StaticResource UniversalImageConverter}}" 
                                               Stretch="UniformToFill"/>
                                        <TextBlock x:Name="PlaceholderText"
                                                   Text="?" 
                                                   FontWeight="Bold" 
                                                   Foreground="#888"
                                                   HorizontalAlignment="Center" 
                                                   VerticalAlignment="Center"
                                                   IsVisible="{Binding PictureUrl, Converter={StaticResource IsNullOrWhiteSpace}}"/>
                                    </Grid>
                                </Border>
                                
                                <!-- Clickable overlay for image change -->
                                <Button x:Name="ImageButton"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        Command="{Binding $parent[ItemsControl].((vm:StudentGalleryViewModel)DataContext).ChangeImageCommand}"
                                        CommandParameter="{Binding}"
                                        ToolTip.Tip="Click to change image"
                                        Template="{StaticResource FlatButtonTemplate}">
                                  <Button.Styles>
                                    <Style Selector="Button:pointerover">
                                      <Setter Property="Background" Value="Transparent"/>
                                    </Style>
                                    <Style Selector="Button:pressed">
                                      <Setter Property="Background" Value="Transparent"/>
                                    </Style>
                                  </Button.Styles>
                                </Button>
                            </Grid>

                            <!-- Student Info -->
                            <StackPanel x:Name="InfoContainer" 
                                        Margin="0,0,0,10">
                                <TextBlock x:Name="NameText"
                                           Text="{Binding Name}" 
                                           FontWeight="Bold" 
                                           HorizontalAlignment="Center"
                                           TextWrapping="Wrap"
                                           TextAlignment="Center"
                                           Margin="0,0,0,5"/>
                                
                                <TextBlock x:Name="ClassText"
                                           Text="{Binding ClassName}" 
                                           Foreground="#666"
                                           HorizontalAlignment="Center"
                                           TextWrapping="Wrap"
                                           TextAlignment="Center"
                                           Margin="0,0,0,5"/>
                                
                                <TextBlock x:Name="MentorText"
                                           Text="{Binding Mentor, StringFormat='Mentor: {0}'}" 
                                           Foreground="#888"
                                           HorizontalAlignment="Center"
                                           TextWrapping="Wrap"
                                           TextAlignment="Center"
                                           Margin="0,0,0,5"/>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Button>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
        
        <!-- Spacer to ensure bottom cards are fully visible when details panel is shown -->
        <Border Grid.Row="1"
                Height="{Binding #SelectedDetailsHost.Bounds.Height}"
                Margin="0"
                IsHitTestVisible="False"
                IsVisible="{Binding SelectedStudent, Converter={x:Static ObjectConverters.IsNotNull}}"/>
        <!-- Fixed overscroll (40px) when selected -->
        <Border Grid.Row="1"
                Height="40"
                IsHitTestVisible="False"
                IsVisible="{Binding SelectedStudent, Converter={x:Static ObjectConverters.IsNotNull}}"/>
        <!-- Overscroll padding when no selection to fully reveal last row -->
        <Border Grid.Row="1"
                Height="40"
                IsHitTestVisible="False"
                IsVisible="{Binding SelectedStudent, Converter={x:Static ObjectConverters.IsNull}}"/>
      </Grid>
    </ScrollViewer>

    <!-- Selected Student Details -->
    <Border Grid.Row="2" x:Name="SelectedDetailsHost"
            Background="Transparent" 
            Padding="20"
            IsVisible="{Binding SelectedStudent, Converter={x:Static ObjectConverters.IsNotNull}}">
      <Border Background="White"
              CornerRadius="8"
              Padding="16"
              BoxShadow="0 2 8 0 #20000000">
        <Grid>
          <Button Content="✎"
                  Width="24" Height="24"
                  Background="#f0f0f0" BorderBrush="#ccc"
                  HorizontalAlignment="Left" VerticalAlignment="Top"
                  HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                  Padding="0"
                  Command="{Binding EditStudentCommand}"
                  CommandParameter="{Binding SelectedStudent}"
                  Template="{StaticResource FlatButtonTemplate}"/>
          <StackPanel Margin="0,32,0,0">
            <TextBlock Text="Selected Student Details" FontSize="18" FontWeight="Bold"/>
            <Separator Margin="0,8,0,8"/>
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
              </Grid.ColumnDefinitions>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>

              <TextBlock Grid.Row="0" Grid.Column="0" Text="Name:" FontWeight="Bold" Margin="0,0,10,0"/>
              <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SelectedStudent.Name}" Margin="0,0,20,0"/>
              
              <TextBlock Grid.Row="0" Grid.Column="2" Text="Email:" FontWeight="Bold" Margin="0,0,10,0"/>
              <TextBlock Grid.Row="0" Grid.Column="3" Text="{Binding SelectedStudent.Email}"/>

              <TextBlock Grid.Row="1" Grid.Column="0" Text="Class:" FontWeight="Bold" Margin="0,0,10,0"/>
              <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SelectedStudent.ClassName}" Margin="0,0,20,0"/>
              
              <TextBlock Grid.Row="1" Grid.Column="2" Text="Mentor:" FontWeight="Bold" Margin="0,0,10,0"/>
              <TextBlock Grid.Row="1" Grid.Column="3" Text="{Binding SelectedStudent.Mentor}"/>
            </Grid>
          </StackPanel>
        </Grid>
      </Border>
    </Border>
  </Grid>
</UserControl>
