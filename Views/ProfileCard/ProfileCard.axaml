<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SchoolOrganizer.ViewModels"
             xmlns:models="using:SchoolOrganizer.Models"
             xmlns:views="using:SchoolOrganizer.Views.Converters"
             xmlns:system="clr-namespace:System;assembly=System.Runtime"
             mc:Ignorable="d" d:DesignWidth="240" d:DesignHeight="320"
             x:Class="SchoolOrganizer.Views.ProfileCard.ProfileCard"
             x:DataType="models:IPerson">

  <UserControl.Resources>
    <views:UniversalImageConverter x:Key="UniversalImageConverter"/>
    <views:DisplayConfigConverter x:Key="DisplayConfigConverter"/>
    <views:AddCardImageConverter x:Key="AddCardImageConverter"/>
    <views:RegularImageConverter x:Key="RegularImageConverter"/>
    <views:AddCardOpacityConverter x:Key="AddCardOpacityConverter"/>
  </UserControl.Resources>

  <UserControl.Styles>
    <!-- Disable hover effects when in Expanded level (student count <= 4) -->
    <Style Selector="Border.ProfileImageBorder:pointerover">
      <Setter Property="RenderTransform" Value="scale(1)"/>
      <Setter Property="Opacity" Value="1"/>
    </Style>
  </UserControl.Styles>

  <Border x:Name="PersonCard"
          Background="{DynamicResource TransparentColor}" 
          CornerRadius="0" 
          Margin="0" 
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch"
          BorderThickness="0"
          ClipToBounds="False"
          Width="240"
          Height="220"
          Opacity="{Binding PictureUrl, Converter={StaticResource AddCardOpacityConverter}}">
    
    <Border.Styles>
      <!-- Add transitions for smooth opacity changes -->
      <Style Selector="Border">
        <Setter Property="Transitions">
          <Transitions>
            <DoubleTransition Property="Opacity" Duration="0:0:0.2"/>
          </Transitions>
        </Setter>
      </Style>
    </Border.Styles>

    <!-- Card Content -->
    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="18,8">
      
      <!-- Profile Image -->
  <Border x:Name="ProfileImageBorder"
        Background="{DynamicResource TransparentColor}"
        Classes="ProfileImageBorder"
        CornerRadius="46"
        BorderThickness="2"
        BorderBrush="{DynamicResource BlackColor}"
        Padding="0"
        PointerReleased="OnProfileImagePointerReleased"
        HorizontalAlignment="Center"
        VerticalAlignment="Center"
        Width="90"
        Height="90"
        Margin="0,0,0,8">
    
        
        <!-- Circular Profile Image -->
        <Grid x:Name="ProfileImageGrid" Width="84" Height="84">
          <!-- Background circle for when no image is present -->
          <Ellipse x:Name="ProfileImageBackground"
                   Width="84" 
                   Height="84"
                   Fill="{DynamicResource BackgroundTertiaryColor}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"/>
          
          <!-- Special background for add card -->
          <Ellipse x:Name="AddCardBackground"
                   Width="84" 
                   Height="84"
                   Fill="{DynamicResource LightBlueColor}"
                   Opacity="0.3"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   IsVisible="{Binding PictureUrl, Converter={StaticResource AddCardImageConverter}}"/>
          
          <!-- Profile image overlay (for regular students) -->
          <Ellipse x:Name="ProfileImageEllipse"
                   Width="84" 
                   Height="84"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   IsVisible="{Binding PictureUrl, Converter={StaticResource RegularImageConverter}}">
            <Ellipse.Fill>
              <ImageBrush Source="{Binding PictureUrl, Converter={StaticResource UniversalImageConverter}}"
                          Stretch="UniformToFill"/>
            </Ellipse.Fill>
          </Ellipse>
          
          <!-- Plus sign for add card (perfectly centered) -->
          <Grid x:Name="AddCardPlusSign"
                Width="84"
                Height="84"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                IsVisible="{Binding PictureUrl, Converter={StaticResource AddCardImageConverter}}">
            <TextBlock Text="+"
                       FontSize="36"
                       FontWeight="Normal"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       TextAlignment="Center"
                       Foreground="{DynamicResource BlackColor}"
                       Margin="0,-4,0,0"/>
          </Grid>
        </Grid>
      </Border>
      
      <!-- Person Information -->
      <StackPanel Margin="0,0,0,6" MaxWidth="160">
        
        <TextBlock x:Name="NameText"
                   Text="{Binding Name}" 
                   FontWeight="Bold" 
                   HorizontalAlignment="Center"
                   TextWrapping="NoWrap"
                   TextAlignment="Center"
                   TextTrimming="CharacterEllipsis"
                   FontSize="16"
                   MaxWidth="160"
                   Margin="0,0,0,3"/>
        
        <TextBlock x:Name="RoleText"
                   Text="{Binding RoleInfo}" 
                   Foreground="{DynamicResource BlackColor}"
                   HorizontalAlignment="Center"
                   TextWrapping="NoWrap"
                   TextAlignment="Center"
                   TextTrimming="CharacterEllipsis"
                   FontSize="12"
                   MaxWidth="160"
                   Margin="0,0,0,3"/>
        
        <TextBlock x:Name="SecondaryText"
                   Text="{Binding SecondaryInfo}" 
                   Foreground="{DynamicResource BlackColor}"
                   HorizontalAlignment="Center"
                   TextWrapping="NoWrap"
                   TextAlignment="Center"
                   TextTrimming="CharacterEllipsis"
                   FontSize="10"
                   MaxWidth="160"
                   Margin="0,0,0,6"
                   IsVisible="{Binding SecondaryInfo, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
        
        <TextBlock x:Name="EmailText"
                   Text="{Binding Email}" 
                   Foreground="{DynamicResource BlackColor}"
                   HorizontalAlignment="Center"
                   TextWrapping="NoWrap"
                   TextAlignment="Center"
                   TextTrimming="CharacterEllipsis"
                   FontSize="9"
                   MaxWidth="160"
                   Margin="0,0,0,5"
                   IsVisible="False"/>
        
        <TextBlock x:Name="EnrollmentText"
                   Foreground="{DynamicResource BlackColor}"
                   HorizontalAlignment="Center"
                   TextWrapping="NoWrap"
                   TextAlignment="Center"
                   TextTrimming="CharacterEllipsis"
                   FontSize="8"
                   MaxWidth="160"
                   Margin="0,0,0,5"
                   IsVisible="False"
                   Text="Enrollment date not available for this person type"/>
        
      </StackPanel>
    </StackPanel>
  </Border>
</UserControl>