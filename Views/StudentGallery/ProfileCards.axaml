<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SchoolOrganizer.ViewModels"
             xmlns:models="using:SchoolOrganizer.Models"
             xmlns:views="using:SchoolOrganizer.Views"
             mc:Ignorable="d" d:DesignWidth="240" d:DesignHeight="320"
             x:Class="SchoolOrganizer.Views.StudentGallery.ProfileCards"
             x:DataType="models:Student">

  <UserControl.Resources>
    <views:UniversalImageConverter x:Key="UniversalImageConverter"/>
    <views:StringIsNullOrWhiteSpaceConverter x:Key="IsNullOrWhiteSpace"/>
    <views:StudentSelectionBrushConverter x:Key="StudentSelectionBrushConverter"/>
    <ControlTemplate x:Key="FlatButtonTemplate">
      <Border Background="{TemplateBinding Background}"
              BorderBrush="{TemplateBinding BorderBrush}"
              BorderThickness="{TemplateBinding BorderThickness}"
              CornerRadius="{TemplateBinding CornerRadius}">
        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                          Content="{TemplateBinding Content}"
                          ContentTemplate="{TemplateBinding ContentTemplate}"/>
      </Border>
    </ControlTemplate>
  </UserControl.Resources>

  <Border x:Name="StudentCard"
          Background="White" 
          CornerRadius="8" 
          Margin="12" 
          Padding="0"
          BoxShadow="0 2 8 0 #20000000"
          HorizontalAlignment="Center"
          VerticalAlignment="Top"
          Cursor="Hand"
          BorderThickness="2"
          Width="240"
          Height="NaN"
          Classes="student-card">
    <Border.Transitions>
      <Transitions>
        <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2"/>
        <BoxShadowsTransition Property="BoxShadow" Duration="0:0:0.2"/>
      </Transitions>
    </Border.Transitions>
    <Border.Styles>
      <Style Selector="Border">
        <Setter Property="RenderTransform" Value="scale(1)"/>
      </Style>
      <Style Selector="Border:pointerover">
        <Setter Property="RenderTransform" Value="scale(1.05)"/>
        <Setter Property="BoxShadow" Value="0 8 24 0 #60000000"/>
      </Style>
    </Border.Styles>

    <Border.BorderBrush>
      <MultiBinding Converter="{StaticResource StudentSelectionBrushConverter}">
        <Binding Path="$parent[UserControl].((vm:StudentGalleryViewModel)DataContext).SelectedStudent"/>
        <Binding Path="."/>
      </MultiBinding>
    </Border.BorderBrush>

    <Grid>
      <!-- Clickable area for the entire card (fills entire border) -->
      <Button Command="{Binding $parent[UserControl].((vm:StudentGalleryViewModel)DataContext).SelectStudentCommand}"
              CommandParameter="{Binding}"
              Background="Transparent"
              BorderThickness="0"
              Padding="18,13.5"
              Cursor="Hand"
              HorizontalAlignment="Stretch"
              VerticalAlignment="Stretch"
              Name="CardButton"
              Template="{StaticResource FlatButtonTemplate}">
        <Button.Styles>
          <Style Selector="Button:pointerover">
            <Setter Property="Background" Value="Transparent"/>
          </Style>
          <Style Selector="Button:pressed">
            <Setter Property="Background" Value="Transparent"/>
          </Style>
        </Button.Styles>
        
        <Grid x:Name="CardContent">
          <!-- Card Content -->
          <StackPanel HorizontalAlignment="Center" VerticalAlignment="Top">
            <!-- Student Image -->
            <Grid x:Name="ImageContainer" 
                  Margin="0,8,0,15" 
                  HorizontalAlignment="Center"
                  Width="168"
                  Height="168">
              <Border x:Name="ImageBorder" 
                      ClipToBounds="True" 
                      Background="#EEE"
                      Width="168"
                      Height="168"
                      CornerRadius="84"
                      BorderThickness="3"
                      BorderBrush="Transparent">
                <Border.Styles>
                  <Style Selector="Border:pointerover">
                    <Setter Property="BorderBrush" Value="#3b536b"/>
                  </Style>
                </Border.Styles>
                <Border.Background>
                  <ImageBrush Source="{Binding PictureUrl, Converter={StaticResource UniversalImageConverter}}"
                              Stretch="UniformToFill"
                              AlignmentX="Center"
                              AlignmentY="Center"/>
                </Border.Background>
                <TextBlock x:Name="PlaceholderText"
                           Text="?" 
                           FontWeight="Bold" 
                           Foreground="#888"
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"
                           FontSize="67"
                           IsVisible="{Binding PictureUrl, Converter={StaticResource IsNullOrWhiteSpace}}"/>
              </Border>
              
              <!-- Invisible clickable overlay for image change -->
              <Button Background="Transparent"
                      BorderThickness="0"
                      Width="168"
                      Height="168"
                      CornerRadius="84"
                      Cursor="Hand"
                      Command="{Binding $parent[UserControl].((vm:StudentGalleryViewModel)DataContext).ChangeImageCommand}"
                      CommandParameter="{Binding}"
                      Template="{StaticResource FlatButtonTemplate}">
                <Button.Styles>
                  <Style Selector="Button:pointerover">
                    <Setter Property="Background" Value="Transparent"/>
                  </Style>
                  <Style Selector="Button:pressed">
                    <Setter Property="Background" Value="Transparent"/>
                  </Style>
                </Button.Styles>
              </Button>

            </Grid>

            <!-- Student Info -->
            <StackPanel x:Name="InfoContainer" 
                        Margin="0,0,0,10"
                        MaxWidth="204">
              <TextBlock x:Name="NameText"
                         Text="{Binding Name}" 
                         FontWeight="Bold" 
                         HorizontalAlignment="Center"
                         TextWrapping="Wrap"
                         TextAlignment="Center"
                         FontSize="16"
                         MaxWidth="204"
                         Margin="0,0,0,5"/>
              
              <TextBlock x:Name="ClassText"
                         Text="{Binding ClassName}" 
                         Foreground="#666"
                         HorizontalAlignment="Center"
                         TextWrapping="Wrap"
                         TextAlignment="Center"
                         FontSize="12"
                         MaxWidth="204"
                         Margin="0,0,0,5"/>
              
              <TextBlock x:Name="MentorText"
                         Text="{Binding Mentor, StringFormat='Mentor: {0}'}" 
                         Foreground="#888"
                         HorizontalAlignment="Center"
                         TextWrapping="Wrap"
                         TextAlignment="Center"
                         FontSize="10"
                         MaxWidth="204"
                         Margin="0,0,0,8"/>
              
            </StackPanel>
          </StackPanel>
        </Grid>
      </Button>
    </Grid>
  </Border>
</UserControl>
