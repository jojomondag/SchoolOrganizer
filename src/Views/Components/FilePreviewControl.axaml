<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:controls="using:SchoolOrganizer.Src.Controls"
             xmlns:components="using:SchoolOrganizer.Src.Views.Components"
             xmlns:models="using:SchoolOrganizer.Src.Models.Assignments"
             xmlns:converters="using:SchoolOrganizer.Src.Converters"
             x:Class="SchoolOrganizer.Src.Views.Components.FilePreviewControl"
             x:DataType="models:StudentFile">

  <UserControl.Resources>
    <converters:ParameterizedConverter x:Key="ParameterizedConverter"/>
  </UserControl.Resources>

  <Border Background="{DynamicResource BackgroundSecondaryBrush}" 
          Margin="0,0,0,0" 
          Padding="0">
    <Grid>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>  <!-- File Header -->
        <RowDefinition Height="Auto"/>  <!-- File Content Preview -->
      </Grid.RowDefinitions>
      
      <!-- File Header -->
      <StackPanel Grid.Row="0" Margin="15,15,15,10">
        <Grid Margin="0,0,0,5">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>
          
          <Button Grid.Column="0"
                  Padding="4"
                  Background="Transparent"
                  BorderThickness="0"
                  CornerRadius="4"
                  Click="OnFileOpenClick"
                  PointerEntered="OnOpenFolderButtonPointerEntered"
                  PointerExited="OnOpenFolderButtonPointerExited"
                  VerticalAlignment="Center"
                  Margin="0,0,5,0">
              <materialIcons:MaterialIcon x:Name="OpenFolderIcon"
                                         Kind="Folder" 
                                         Width="18" 
                                         Height="18"
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
          </Button>
          
          <StackPanel Grid.Column="1" Orientation="Horizontal">
            <TextBlock Text="{Binding FileName}" 
                       FontWeight="Bold" 
                       FontSize="14"
                       VerticalAlignment="Center"/>
            <TextBlock Text="{Binding FileSizeFormatted, StringFormat=' ({0})'}" 
                       Foreground="Gray" 
                       FontSize="12" 
                       VerticalAlignment="Center" 
                       Margin="5,0,0,0"/>
          </StackPanel>
          
          <TextBlock Grid.Column="2" 
                     Text="{Binding LastModifiedFormatted}" 
                     Foreground="Gray" 
                     FontSize="10" 
                     VerticalAlignment="Center" 
                     Margin="10,0,5,0"/>
          
          <!-- Expand/Collapse Button (for code/text files) -->
          <Button Grid.Column="3"
                  x:Name="MaximizerButton"
                  Padding="4"
                  Background="Transparent"
                  BorderThickness="0"
                  CornerRadius="4"
                  Click="OnMaximizerClick"
                  VerticalAlignment="Center"
                  Margin="0,0,0,0">
              <materialIcons:MaterialIcon x:Name="MaximizerIcon"
                                         Kind="Fullscreen" 
                                         Width="18" 
                                         Height="18"
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
          </Button>
        </Grid>
      </StackPanel>
      
      <!-- File Content Preview -->
      <ScrollViewer Grid.Row="1"
                    x:Name="ContentScrollViewer"
                    VerticalScrollBarVisibility="Auto"
                    HorizontalScrollBarVisibility="Auto"
                    Margin="0,0,0,0"
                    Padding="0">
              <ScrollViewer.MaxHeight>
                <Binding Path="IsExpanded">
                  <Binding.Converter>
                    <converters:ParameterizedConverter/>
                  </Binding.Converter>
                  <Binding.ConverterParameter>Infinity|400</Binding.ConverterParameter>
                </Binding>
              </ScrollViewer.MaxHeight>
          <Grid>
            <!-- Google Docs Viewer (Highest Priority) -->
            <components:GoogleDocsViewer IsVisible="{Binding IsGoogleDoc}"/>

            <!-- Document Files (docx, xlsx, pptx, pdf) -->
            <StackPanel IsVisible="{Binding IsNone}"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Spacing="16"
                        Margin="40">
              <materialIcons:MaterialIcon Kind="FileDocument"
                                          Width="64"
                                          Height="64"
                                          Foreground="{DynamicResource TextSecondaryBrush}"/>
              <TextBlock Text="{Binding FileName}"
                         FontWeight="SemiBold"
                         FontSize="16"
                         HorizontalAlignment="Center"
                         TextWrapping="Wrap"
                         MaxWidth="400"/>
              <TextBlock Text="Document file - click below to open"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         HorizontalAlignment="Center"/>
              <Button Click="OnFileOpenClick"
                      Padding="12,6"
                      HorizontalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <materialIcons:MaterialIcon Kind="FolderOpen" Width="16" Height="16"/>
                  <TextBlock Text="Open File" VerticalAlignment="Center"/>
                </StackPanel>
              </Button>
            </StackPanel>

            <!-- Image Content -->
            <Image Source="{Binding ImageSource}"
                   Stretch="Uniform"
                   MaxHeight="300"
                   HorizontalAlignment="Stretch"
                   IsVisible="{Binding IsImage}"/>

            <!-- Code Content -->
            <controls:SyntaxHighlightedCodeViewer
                CodeContent="{Binding CodeContent}"
                FileExtension="{Binding FileExtension}"
                IsVisible="{Binding IsCode}"
                HorizontalAlignment="Stretch">
              <controls:SyntaxHighlightedCodeViewer.MaxHeight>
                <Binding Path="IsExpanded">
                  <Binding.Converter>
                    <converters:ParameterizedConverter/>
                  </Binding.Converter>
                  <Binding.ConverterParameter>Infinity|300</Binding.ConverterParameter>
                </Binding>
              </controls:SyntaxHighlightedCodeViewer.MaxHeight>
            </controls:SyntaxHighlightedCodeViewer>

            <!-- Text Content -->
            <TextBlock Text="{Binding TextContent}"
                       FontFamily="Consolas, Courier New, monospace"
                       FontSize="12"
                       TextWrapping="Wrap"
                       IsVisible="{Binding IsText}"
                       HorizontalAlignment="Stretch">
              <TextBlock.MaxHeight>
                <Binding Path="IsExpanded">
                  <Binding.Converter>
                    <converters:ParameterizedConverter/>
                  </Binding.Converter>
                  <Binding.ConverterParameter>Infinity|300</Binding.ConverterParameter>
                </Binding>
              </TextBlock.MaxHeight>
              <TextBlock.TextTrimming>
                <Binding Path="IsExpanded">
                  <Binding.Converter>
                    <converters:ParameterizedConverter/>
                  </Binding.Converter>
                  <Binding.ConverterParameter>None|CharacterEllipsis</Binding.ConverterParameter>
                </Binding>
              </TextBlock.TextTrimming>
            </TextBlock>

            <!-- Binary/Unsupported Content (Lowest Priority - Fallback) -->
            <StackPanel IsVisible="{Binding IsBinary}"
                        HorizontalAlignment="Center"
                        Margin="20">
              <TextBlock Text="Binary file - cannot preview"
                         FontStyle="Italic"
                         Foreground="Gray"
                         HorizontalAlignment="Center"/>
              <TextBlock Text="{Binding FileSizeFormatted, StringFormat='Size: {0}'}"
                         FontSize="10"
                         Foreground="Gray"
                         HorizontalAlignment="Center"
                         Margin="0,5,0,0"/>
            </StackPanel>
          </Grid>
      </ScrollViewer>
    </Grid>
  </Border>
</UserControl>
