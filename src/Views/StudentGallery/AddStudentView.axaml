<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:views="using:SchoolOrganizer.Src.Converters"
             xmlns:vm="using:SchoolOrganizer.Src.ViewModels"
             xmlns:components="using:SchoolOrganizer.Src.Views.ProfileCards.Components"
             xmlns:materialIcons="using:Material.Icons.Avalonia"
             x:Class="SchoolOrganizer.Src.Views.StudentGallery.AddStudentView"
             x:DataType="vm:AddStudentViewModel">

  <UserControl.Resources>
    <views:UniversalImageConverter x:Key="UniversalImageConverter"/>
  </UserControl.Resources>


  <Border Background="{DynamicResource BackgroundPrimaryBrush}" Padding="12">
    <Grid RowDefinitions="Auto,*,Auto">
      <!-- Header -->
      <StackPanel Grid.Row="0" Margin="0,0,0,8">
        <TextBlock Text="Add Student" FontSize="22" FontWeight="Light" Foreground="{DynamicResource TextPrimaryBrush}"/>
        <Rectangle Height="1" Fill="{DynamicResource BlackBrush}" Margin="0,6,0,0"/>
      </StackPanel>

      <!-- Content -->
      <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,0,-4,0">
        <StackPanel Spacing="12" Margin="0,0,12,0">
          
          <!-- Manual Entry Form -->
          <StackPanel IsVisible="{Binding IsManualMode}">
            <!-- Photo and Form Fields Section -->
            <Grid ColumnDefinitions="Auto,24,*">
              <!-- Profile Image -->
              <StackPanel Grid.Column="0" Spacing="8" MinWidth="120" MaxWidth="140">
                <components:ProfileImage x:Name="ProfileImage"
                                               Width="110"
                                               Height="110"
                                               ImagePath="{Binding SelectedImagePath, Mode=TwoWay}"
                                               IsClickable="True"/>
                <TextBlock Text="Click to add photo" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center" TextWrapping="Wrap"/>
              </StackPanel>

              <!-- All Form Fields -->
              <StackPanel Grid.Column="2" Spacing="12">
                <!-- Name and Email Fields (side by side) -->
                <Grid ColumnDefinitions="*,20,*">
                  <StackPanel Grid.Column="0">
                    <TextBlock Text="Name *" FontSize="12" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding StudentName}" Watermark="Enter full name" HorizontalAlignment="Stretch"/>
                  </StackPanel>

                  <StackPanel Grid.Column="2">
                    <TextBlock Text="Email" FontSize="12" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,4"/>
                    <TextBox Text="{Binding StudentEmail}" Watermark="student@example.com" HorizontalAlignment="Stretch"/>
                  </StackPanel>
                </Grid>

                <!-- Class and Enrollment Date (side by side) -->
                <Grid ColumnDefinitions="*,20,*">
                  <StackPanel Grid.Column="0">
                    <TextBlock Text="Class" FontSize="12" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,4"/>
                    <ComboBox ItemsSource="{Binding AvailableClasses}" SelectedItem="{Binding SelectedClassName}" HorizontalAlignment="Stretch"/>
                  </StackPanel>

                  <StackPanel Grid.Column="2">
                    <TextBlock Text="Enrollment Date" FontSize="12" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,4"/>
                    <DatePicker SelectedDate="{Binding EnrollmentDate}" HorizontalAlignment="Stretch"/>
                  </StackPanel>
                </Grid>

                <!-- Teachers Section -->
                <StackPanel>
                  <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0" Text="Teachers" FontSize="12" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                    <Button Grid.Column="1" 
                            Classes="secondary" 
                            Padding="8,4" Margin="0,0,0,6"
                            Click="OnAddTeacherClick">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <materialIcons:MaterialIcon Kind="Plus" Width="24" Height="24" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <TextBlock Text="Add Teacher" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                      </StackPanel>
                    </Button>
                  </Grid>
                  
                  <!-- Selected Teachers List -->
                  <ItemsControl ItemsSource="{Binding SelectedTeachers}" Margin="0,0,0,8">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <WrapPanel/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="{DynamicResource BackgroundTertiaryBrush}" CornerRadius="4" Padding="8,4" Margin="3,2">
                          <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="{Binding}" VerticalAlignment="Center" FontSize="11" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            <Button Grid.Column="1" Content="Ã—" FontSize="12" FontWeight="Bold"
                                    Background="{DynamicResource TransparentColor}" BorderThickness="0" 
                                    Foreground="{DynamicResource TextPrimaryBrush}" Padding="4,0"
                                    Click="OnRemoveTeacherClick" Tag="{Binding}"
                                    ToolTip.Tip="Remove teacher"/>
                          </Grid>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                  
                  <!-- Teacher Selection ComboBox (initially hidden) -->
                  <ComboBox Name="TeacherBox" ItemsSource="{Binding AvailableTeachers}" 
                            IsVisible="False" SelectionChanged="OnTeacherSelected" HorizontalAlignment="Stretch"/>
                </StackPanel>
              </StackPanel>
            </Grid>
          </StackPanel>

          <!-- Classroom Import Form -->
          <StackPanel IsVisible="{Binding IsClassroomMode}">
            <!-- Classroom Selection -->
            <StackPanel Margin="0,0,0,12">
              
              <!-- Loading State -->
              <StackPanel IsVisible="{Binding IsLoadingClassrooms}" HorizontalAlignment="Center" Margin="0,16">
                <TextBlock Text="Loading classrooms..." FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
              </StackPanel>
              
              <!-- Classroom Cards Grid -->
              <ScrollViewer IsVisible="{Binding !IsLoadingClassrooms}"
                           VerticalScrollBarVisibility="Auto"
                           MaxHeight="200"
                           HorizontalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding AvailableClassrooms}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <UniformGrid Columns="3" Margin="0,0,8,6"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="{DynamicResource BackgroundPrimaryBrush}" 
                              BorderBrush="{DynamicResource BlackBrush}" 
                              BorderThickness="1" 
                              CornerRadius="6" 
                              Margin="3"
                              Padding="10,6"
                              Cursor="Hand"
                              PointerPressed="OnClassroomCardPressed">
                        <Grid RowDefinitions="Auto,Auto">
                          <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="{Binding Name}" 
                                       FontSize="13" 
                                       FontWeight="SemiBold" 
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="1" Text="{Binding Section}" 
                                       FontSize="9" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Right"
                                       VerticalAlignment="Center"
                                       Margin="4,0,0,0"
                                       TextTrimming="CharacterEllipsis"
                                       MaxWidth="80"
                                       IsVisible="{Binding Section, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                          </Grid>
                          <TextBlock Grid.Row="1" Text="{Binding Description}" 
                                     FontSize="7" 
                                     Foreground="{DynamicResource TextSecondaryBrush}"
                                     TextWrapping="Wrap"
                                     MaxHeight="16"
                                     TextTrimming="CharacterEllipsis"
                                     IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                     Margin="0,1,0,0"/>
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
              
              <!-- No Classrooms Message -->
              <StackPanel IsVisible="{Binding !IsLoadingClassrooms}" 
                         HorizontalAlignment="Center" 
                         Margin="0,16">
                <StackPanel IsVisible="{Binding AvailableClassrooms.Count, Converter={x:Static views:ComparisonConverter.Instance}, ConverterParameter='==,0'}">
                  <TextBlock Text="No classrooms available" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                  <TextBlock Text="Make sure you're logged in with Google and have access to Google Classroom" 
                             FontSize="9" 
                             Foreground="{DynamicResource TextSecondaryBrush}" 
                             HorizontalAlignment="Center" 
                             TextWrapping="Wrap"
                             Margin="0,3,0,0"/>
                </StackPanel>
              </StackPanel>
            </StackPanel>

            <!-- Students List -->
            <StackPanel IsVisible="{Binding SelectedClassroom, Converter={x:Static ObjectConverters.IsNotNull}}">
              <Grid ColumnDefinitions="*,Auto,Auto" Margin="0,0,0,6">
                <TextBlock Grid.Column="0" Text="Select Students to Import" FontSize="12" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                <Button Grid.Column="1" Content="Select All" Classes="secondary" FontSize="10" Padding="6,3" Margin="0,0,6,0" Command="{Binding SelectAllClassroomStudentsCommand}"/>
                <Button Grid.Column="2" Content="Deselect All" Classes="secondary" FontSize="10" Padding="6,3" Command="{Binding DeselectAllClassroomStudentsCommand}"/>
              </Grid>
              
              <!-- Students List -->
              <Border Background="{DynamicResource BackgroundPrimaryBrush}" 
                      BorderBrush="{DynamicResource BlackBrush}" 
                      BorderThickness="1" 
                      CornerRadius="6" 
                      MaxHeight="400">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="8">
                  <ItemsControl ItemsSource="{Binding ClassroomStudents}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <UniformGrid Columns="2"/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <CheckBox Content="{Binding ClassroomStudent.Profile.Name.FullName}" 
                                  IsChecked="{Binding IsSelected}" 
                                  Margin="4,2" FontSize="11"/>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </ScrollViewer>
              </Border>
            </StackPanel>
          </StackPanel>
        </StackPanel>
      </ScrollViewer>

      <!-- Footer -->
      <StackPanel Grid.Row="2" Margin="0,16,0,0">
        <Rectangle Height="1" Fill="{DynamicResource BlackBrush}" Margin="0,0,0,12"/>
        <Grid ColumnDefinitions="*,Auto,Auto">
          <TextBlock Grid.Column="0" Text="{Binding ValidationText}" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" FontSize="12"/>
          <Button Grid.Column="1" Content="Cancel" Classes="secondary" Command="{Binding CancelCommand}" Margin="0,0,8,0"/>
          <Button Grid.Column="2" Content="{Binding PrimaryButtonText}" Classes="primary" Command="{Binding AddStudentCommand}"/>
        </Grid>
      </StackPanel>
    </Grid>
  </Border>
</UserControl>
