<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SchoolOrganizer.Src.ViewModels"
             xmlns:converters="using:SchoolOrganizer.Src.Converters"
             xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:Views="using:SchoolOrganizer.Src.Views"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="SchoolOrganizer.Src.Views.ClassroomDownload.ClassroomDownloadView"
             x:DataType="vm:ClassroomDownloadViewModel">

    <UserControl.Resources>
        <converters:ParameterizedConverter x:Key="ParameterizedConverter"/>
    </UserControl.Resources>

    <Grid Background="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Border Grid.Row="0"
                Background="{DynamicResource BackgroundPrimaryBrush}"
                Padding="32,24"
                Margin="0,0,0,16"
                IsVisible="{Binding !IsShowingContent}">
            <StackPanel HorizontalAlignment="Center" Spacing="16">
                <!-- Collapsible Header with Arrow -->
                <Button Command="{Binding ToggleDownloadSectionCommand}"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="0"
                        HorizontalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                        <TextBlock Text="Download Folder"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryColor}"
                                   VerticalAlignment="Center"/>
                        <materialIcons:MaterialIcon Kind="{Binding IsDownloadSectionExpanded, Converter={StaticResource ParameterizedConverter}, ConverterParameter=MenuDown|MenuUp}"
                                                     Width="20"
                                                     Height="20"
                                                     Foreground="{DynamicResource TextSecondaryBrush}"
                                                     VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                
                <!-- Collapsible Content -->
                <StackPanel Orientation="Horizontal" 
                           Spacing="16" 
                           HorizontalAlignment="Center"
                           IsVisible="{Binding IsDownloadSectionExpanded}">
                    <TextBox Text="{Binding SelectedFolderPath}"
                             Width="400"
                             Height="40"
                             IsReadOnly="True"
                             Background="{DynamicResource BackgroundTertiaryBrush}"
                             BorderBrush="{DynamicResource CardBorderBrush}"
                             BorderThickness="1"
                             Padding="16,10"
                             FontSize="14"
                             CornerRadius="8"
                             HorizontalAlignment="Center"/>
                    <Button x:Name="BrowseButton"
                            Click="OnBrowseFolderClick"
                            Padding="20,10"
                            Background="{DynamicResource AccentButtonBackground}"
                            Foreground="White"
                            BorderThickness="0"
                            CornerRadius="8"
                            FontWeight="SemiBold"
                            FontSize="14"
                            Height="40"
                            PointerEntered="OnBrowseButtonPointerEntered"
                            PointerExited="OnBrowseButtonPointerExited">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <materialIcons:MaterialIcon x:Name="BrowseIcon"
                                                       Kind="FolderOpen" 
                                                       Width="18" 
                                                       Height="18"
                                                       Foreground="White"/>
                            <TextBlock Text="Choose Folder" 
                                       FontSize="14"
                                       Foreground="White"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Classrooms List Section -->
        <Grid Grid.Row="1"
              Margin="20,0"
              IsVisible="{Binding !IsShowingContent}">
            <ListBox ItemsSource="{Binding Classrooms}"
                     SelectedItem="{Binding SelectedCourse}"
                     Background="Transparent"
                     BorderThickness="0"
                     ClipToBounds="True">
                <ListBox.Styles>
                    <Style Selector="ListBoxItem">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                        <Setter Property="Template">
                            <ControlTemplate TargetType="ListBoxItem">
                                <Border Background="Transparent" 
                                        BorderBrush="Transparent" 
                                        BorderThickness="0"
                                        Padding="0">
                                    <ContentPresenter Content="{TemplateBinding Content}"
                                                    ContentTemplate="{TemplateBinding ContentTemplate}"
                                                    Margin="{TemplateBinding Padding}"/>
                                </Border>
                            </ControlTemplate>
                        </Setter>
                    </Style>
                    <Style Selector="ListBoxItem:pointerover">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                    <Style Selector="ListBoxItem:selected">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                    <Style Selector="ListBoxItem:selected:pointerover">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                    <Style Selector="ListBoxItem:focused">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                </ListBox.Styles>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border x:Name="CourseCardBorder"
                                    CornerRadius="8"
                                    Padding="16"
                                    Margin="8,1"
                                    Background="{DynamicResource BackgroundPrimaryBrush}"
                                    BorderBrush="{DynamicResource CardBorderBrush}"
                                    BorderThickness="1"
                                    BoxShadow="{DynamicResource ShadowLight}"
                                    Cursor="Hand"
                                    RenderTransformOrigin="0.5,0.5"
                                    PointerEntered="OnCourseCardPointerEntered"
                                    PointerExited="OnCourseCardPointerExited">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0" Spacing="4">
                                        <TextBlock Text="{Binding Course.Name}"
                                                   FontSize="14"
                                                   FontWeight="Bold"
                                                   Foreground="{DynamicResource TextPrimaryColor}"/>
                                        <TextBlock Text="{Binding Course.Section}"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource TextSecondaryColor}"/>
                                    </StackPanel>

                                    <!-- Status Indicator -->
                                    <Border Grid.Column="1"
                                            Background="{Binding IsDownloaded, Converter={StaticResource ParameterizedConverter}, ConverterParameter=Green|Gray}"
                                            Width="12"
                                            Height="12"
                                            CornerRadius="6"
                                            Margin="10,0"
                                            VerticalAlignment="Center"
                                            ToolTip.Tip="{Binding IsDownloaded, Converter={StaticResource ParameterizedConverter}, ConverterParameter=Download completed|Not downloaded}"/>

                                    <!-- Button Stack -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                        <!-- View Content Button (only visible if folder exists) -->
                                        <Button Command="{Binding OpenCourseDataCommand}"
                                                IsVisible="{Binding HasFolder}"
                                                Padding="12,6"
                                                Content="View Assignments"
                                                Background="{DynamicResource AccentButtonBackground}"
                                                Foreground="White"
                                                BorderThickness="0"
                                                CornerRadius="4">
                                            <Button.Styles>
                                                <Style Selector="Button:pointerover">
                                                    <Setter Property="Background" Value="{DynamicResource AccentButtonBackgroundHover}"/>
                                                </Style>
                                            </Button.Styles>
                                        </Button>

                                        <!-- Sync Button (only visible if folder exists) -->
                                        <Button Command="{Binding SyncCommand}"
                                                IsVisible="{Binding HasFolder}"
                                                Padding="10,6"
                                                CornerRadius="4"
                                                ToolTip.Tip="{Binding IsAutoSyncEnabled, Converter={StaticResource ParameterizedConverter}, ConverterParameter=Auto-sync enabled - click to disable|Enable auto-sync}">
                                            <Button.Background>
                                                <SolidColorBrush Color="{Binding IsAutoSyncEnabled, Converter={StaticResource ParameterizedConverter}, ConverterParameter=#2563eb|Transparent}"/>
                                            </Button.Background>
                                            <Button.BorderBrush>
                                                <SolidColorBrush Color="{Binding IsAutoSyncEnabled, Converter={StaticResource ParameterizedConverter}, ConverterParameter=#2563eb|#2563eb}"/>
                                            </Button.BorderBrush>
                                            <Button.BorderThickness>
                                                <Binding Path="IsAutoSyncEnabled" Converter="{StaticResource ParameterizedConverter}" ConverterParameter="0|1"/>
                                            </Button.BorderThickness>
                                            <materialIcons:MaterialIcon Kind="Sync"
                                                                       Width="18"
                                                                       Height="18">
                                                <materialIcons:MaterialIcon.Foreground>
                                                    <SolidColorBrush Color="{Binding IsAutoSyncEnabled, Converter={StaticResource ParameterizedConverter}, ConverterParameter=White|#2563eb}"/>
                                                </materialIcons:MaterialIcon.Foreground>
                                            </materialIcons:MaterialIcon>
                                            <Button.Styles>
                                                <Style Selector="Button:pointerover">
                                                    <Setter Property="Background" Value="#2563eb"/>
                                                </Style>
                                                <Style Selector="Button:pointerover materialIcons|MaterialIcon">
                                                    <Setter Property="Foreground" Value="White"/>
                                                </Style>
                                            </Button.Styles>
                                        </Button>

                                        <!-- Download Button (hidden when auto-sync is active) -->
                                        <Button Command="{Binding DownloadCommand}"
                                                IsVisible="{Binding !IsAutoSyncEnabled}"
                                                Padding="12,6"
                                                Content="Download"
                                                Background="{DynamicResource AccentButtonBackground}"
                                                Foreground="White"
                                                BorderThickness="0"
                                                CornerRadius="4">
                                            <Button.Styles>
                                                <Style Selector="Button:pointerover">
                                                    <Setter Property="Background" Value="{DynamicResource AccentButtonBackgroundHover}"/>
                                                </Style>
                                            </Button.Styles>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
        </Grid>

        <!-- Content View Section -->
        <Grid Grid.Row="1"
              Margin="20,0"
              IsVisible="{Binding IsShowingContent}">
            <!-- Content View -->
            <ListBox ItemsSource="{Binding CurrentContentViewModel.Students}"
                     Background="Transparent"
                     BorderThickness="0"
                     ClipToBounds="True">
                <ListBox.Styles>
                    <Style Selector="ListBoxItem">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                        <Setter Property="Template">
                            <ControlTemplate TargetType="ListBoxItem">
                                <Border Background="Transparent" 
                                        BorderBrush="Transparent" 
                                        BorderThickness="0"
                                        Padding="0">
                                    <ContentPresenter Content="{TemplateBinding Content}"
                                                    ContentTemplate="{TemplateBinding ContentTemplate}"
                                                    Margin="{TemplateBinding Padding}"/>
                                </Border>
                            </ControlTemplate>
                        </Setter>
                    </Style>
                    <Style Selector="ListBoxItem:pointerover">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                    <Style Selector="ListBoxItem:selected">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                    <Style Selector="ListBoxItem:selected:pointerover">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                    <Style Selector="ListBoxItem:focused">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="Transparent"/>
                    </Style>
                </ListBox.Styles>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border x:Name="StudentCardBorder"
                                CornerRadius="8"
                                Padding="16"
                                Margin="8,1"
                                Background="{DynamicResource BackgroundPrimaryBrush}"
                                BorderBrush="{DynamicResource CardBorderBrush}"
                                BorderThickness="1"
                                BoxShadow="{DynamicResource ShadowLight}"
                                Cursor="Hand"
                                RenderTransformOrigin="0.5,0.5"
                                PointerEntered="OnStudentCardPointerEntered"
                                PointerExited="OnStudentCardPointerExited">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <Grid Grid.Column="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding Name}"
                                               FontSize="14"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource TextPrimaryColor}"
                                               VerticalAlignment="Center"/>
                                    
                                    <StackPanel Grid.Column="1" 
                                                Orientation="Horizontal" 
                                                Spacing="15"
                                                VerticalAlignment="Center"
                                                Margin="20,0,20,0">
                                        <TextBlock Text="{Binding AssignmentCount, StringFormat='Assignments: {0}'}"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource TextSecondaryColor}"/>
                                        <TextBlock Text="{Binding FileCount, StringFormat='Files: {0}'}"
                                                   FontSize="12"
                                                   Foreground="{DynamicResource TextSecondaryColor}"/>
                                    </StackPanel>
                                </Grid>

                                <!-- Button Stack -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                                    <Button Content="Assignments"
                                            Command="{Binding $parent[ListBox].((vm:ClassroomDownloadViewModel)DataContext).CurrentContentViewModel.ViewStudentDetailCommand}"
                                            CommandParameter="{Binding}"
                                            Padding="12,6"
                                            Background="{DynamicResource AccentButtonBackground}"
                                            Foreground="White"
                                            BorderThickness="0"
                                            CornerRadius="4">
                                        <Button.Styles>
                                            <Style Selector="Button:pointerover">
                                                <Setter Property="Background" Value="{DynamicResource AccentButtonBackgroundHover}"/>
                                            </Style>
                                        </Button.Styles>
                                    </Button>
                                </StackPanel>

                                <Button Grid.Column="2"
                                        Command="{Binding $parent[ListBox].((vm:ClassroomDownloadViewModel)DataContext).CurrentContentViewModel.OpenStudentFolderCommand}"
                                        CommandParameter="{Binding}"
                                        Padding="12,6"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        CornerRadius="4"
                                        PointerEntered="OnOpenFolderButtonPointerEntered"
                                        PointerExited="OnOpenFolderButtonPointerExited">
                                    <materialIcons:MaterialIcon x:Name="OpenFolderIcon"
                                                               Kind="Folder" 
                                                               Width="18" 
                                                               Height="18"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </Button>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2"
                Background="{DynamicResource BackgroundSecondaryBrush}"
                Padding="24,16"
                Margin="0,16,0,0">
            <TextBlock Text="{Binding StatusText}"
                       FontSize="14"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       TextWrapping="Wrap"
                       HorizontalAlignment="Center"
                       TextAlignment="Center"/>
        </Border>
    </Grid>
</UserControl>
