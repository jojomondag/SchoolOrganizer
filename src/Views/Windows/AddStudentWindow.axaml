<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="using:SchoolOrganizer.Src.Converters"
        xmlns:windows="using:SchoolOrganizer.Src.Views.Windows"
        x:Class="SchoolOrganizer.Src.Views.Windows.AddStudentWindow"
        x:DataType="windows:AddStudentWindow+AddStudentState"
        Width="420" Height="480"
        CanResize="False"
        Title="Add New Student">

  <Window.Resources>
    <views:UniversalImageConverter x:Key="UniversalImageConverter"/>
  </Window.Resources>

  <Window.Styles>
    <!-- Tab styles matching MainWindow -->
    <Style Selector="ToggleButton.tab">
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="Padding" Value="16,8"/>
      <Setter Property="Background" Value="{DynamicResource BackgroundTertiaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
      <Setter Property="BorderBrush" Value="Transparent"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="CornerRadius" Value="10,10,0,0"/>
      <Setter Property="Margin" Value="0,0,4,0"/>
      <Setter Property="FocusAdorner" Value="{x:Null}"/>
      <Setter Property="Cursor" Value="Hand"/>
    </Style>

    <!-- Unchecked hover state -->
    <Style Selector="ToggleButton.tab:pointerover">
      <Setter Property="Background" Value="{DynamicResource BackgroundSecondaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
    </Style>

    <!-- Checked state - active tab -->
    <Style Selector="ToggleButton.tab:checked">
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
      <Setter Property="FontWeight" Value="Bold"/>
    </Style>

    <!-- Target the ContentPresenter within the template for checked state -->
    <Style Selector="ToggleButton.tab:checked /template/ ContentPresenter#PART_ContentPresenter">
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
    </Style>

    <!-- Target the Border within the template for checked state -->
    <Style Selector="ToggleButton.tab:checked /template/ Border#PART_ButtonBorder">
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource BackgroundPrimaryBrush}"/>
    </Style>

    <!-- Checked and hover state - keep active appearance -->
    <Style Selector="ToggleButton.tab:checked:pointerover">
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
    </Style>

    <!-- Ensure template elements stay consistent when checked and hovered -->
    <Style Selector="ToggleButton.tab:checked:pointerover /template/ ContentPresenter#PART_ContentPresenter">
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
    </Style>

    <Style Selector="ToggleButton.tab:checked:pointerover /template/ Border#PART_ButtonBorder">
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource BackgroundPrimaryBrush}"/>
    </Style>

    <!-- Pressed state for unchecked tabs -->
    <Style Selector="ToggleButton.tab:pressed">
      <Setter Property="Background" Value="{DynamicResource BackgroundSecondaryBrush}"/>
    </Style>

    <Style Selector="TextBox">
      <Setter Property="Padding" Value="12,8"/>
      <Setter Property="BorderBrush" Value="{DynamicResource BlackBrush}"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
      <Setter Property="FocusAdorner" Value="{x:Null}"/>
    </Style>
    
    <Style Selector="TextBox:focus">
      <Setter Property="BorderBrush" Value="{DynamicResource TextSecondaryBrush}"/>
      <Setter Property="BorderThickness" Value="2"/>
      <Setter Property="FocusAdorner" Value="{x:Null}"/>
    </Style>
    
    <Style Selector="TextBox:focus /template/ Border">
      <Setter Property="BorderBrush" Value="{DynamicResource TextSecondaryBrush}"/>
      <Setter Property="BorderThickness" Value="2"/>
    </Style>
    
    <Style Selector="ComboBox">
      <Setter Property="Padding" Value="12,8"/>
      <Setter Property="BorderBrush" Value="{DynamicResource BlackBrush}"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
    </Style>
    
    <Style Selector="DatePicker">
      <Setter Property="BorderBrush" Value="{DynamicResource BlackBrush}"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="Background" Value="{DynamicResource BackgroundPrimaryBrush}"/>
    </Style>
    
    <Style Selector="ComboBox:focus">
      <Setter Property="BorderBrush" Value="{DynamicResource TextSecondaryBrush}"/>
      <Setter Property="BorderThickness" Value="2"/>
    </Style>
    
    <Style Selector="DatePicker:focus">
      <Setter Property="BorderBrush" Value="{DynamicResource TextSecondaryBrush}"/>
      <Setter Property="BorderThickness" Value="2"/>
    </Style>
    
    <Style Selector="Button.secondary">
      <Setter Property="Background" Value="{DynamicResource TransparentColor}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource BlackBrush}"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
      <Setter Property="Padding" Value="20,8"/>
      <Setter Property="CornerRadius" Value="6"/>
    </Style>
    
    <Style Selector="Button.secondary:pointerover">
      <Setter Property="Background" Value="{DynamicResource BackgroundSecondaryBrush}"/>
    </Style>
    
    <Style Selector="Button.primary">
      <Setter Property="Background" Value="{DynamicResource BlackBrush}"/>
      <Setter Property="Foreground" Value="{DynamicResource WhiteBrush}"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="Padding" Value="24,8"/>
      <Setter Property="CornerRadius" Value="6"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
    </Style>
    
    <Style Selector="Button.primary:pointerover">
      <Setter Property="Background" Value="{DynamicResource BlackBrush}"/>
    </Style>
  </Window.Styles>

  <Border Background="{DynamicResource BackgroundTertiaryBrush}" Padding="24">
    <Grid RowDefinitions="Auto,Auto,*,Auto">
      <!-- Mode Tabs at the top -->
      <StackPanel Grid.Row="0" Margin="0,0,0,16">
        <StackPanel Orientation="Horizontal" Spacing="0">
          <ToggleButton Classes="tab"
                        IsChecked="{Binding IsManualMode}"
                        Command="{Binding SwitchToManualModeCommand}"
                        Content="Manual Entry"/>
          <ToggleButton Classes="tab"
                        IsChecked="{Binding IsClassroomMode}"
                        Command="{Binding SwitchToClassroomModeCommand}"
                        Content="From Classroom"/>
        </StackPanel>
      </StackPanel>

      <!-- Header -->
      <StackPanel Grid.Row="1" Margin="0,0,0,16">
        <TextBlock Text="Add Student" FontSize="24" FontWeight="Light" Name="TitleText" Foreground="{DynamicResource TextPrimaryBrush}"/>
        <Rectangle Height="1" Fill="{DynamicResource BlackBrush}" Margin="0,8,0,0"/>
      </StackPanel>

      <!-- Content -->
      <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,0,-4,0">
        <StackPanel Spacing="20" Margin="0,0,20,0">
          
          <!-- Manual Entry Mode -->
          <StackPanel IsVisible="{Binding IsManualMode}">
            <!-- Photo and Class/Teacher Section -->
            <Grid ColumnDefinitions="140,20,*">
              <!-- Profile Image -->
              <StackPanel Grid.Column="0" Spacing="8">
                <Border x:Name="ProfileImageBorder"
                        Width="100"
                        Height="100"
                        CornerRadius="50"
                        ClipToBounds="True"
                        Background="{DynamicResource BackgroundTertiaryBrush}"
                        BorderBrush="{DynamicResource BlackBrush}"
                        BorderThickness="2"
                        BoxShadow="{DynamicResource ShadowLight}"
                        Cursor="Hand"
                        PointerPressed="OnProfileImagePointerPressed">
                  <Grid>
                    <Image Source="{Binding SelectedImagePath, Converter={StaticResource UniversalImageConverter}}" Stretch="UniformToFill" IsHitTestVisible="False"/>
                    <TextBlock Text="+" FontSize="28" FontWeight="Light" Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center" IsVisible="{Binding IsImageMissing}" IsHitTestVisible="False"/>
                  </Grid>
                </Border>
                <TextBlock Text="Add Photo" FontSize="12" Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center"/>
              </StackPanel>

              <!-- Class and Teacher in 2 rows -->
              <Grid Grid.Column="2" RowDefinitions="Auto,16,Auto">
                <StackPanel Grid.Row="0">
                  <TextBlock Text="Class" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                  <ComboBox Name="ClassBox" ItemsSource="{Binding AvailableClasses}"/>
                </StackPanel>

                <StackPanel Grid.Row="2">
                  <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0" Text="Teachers" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                    <Button Grid.Column="1" Content="+ Add Teacher" 
                            Classes="secondary" FontSize="11" 
                            Padding="8,4" Margin="0,0,0,6"
                            Click="OnAddTeacherClick"/>
                  </Grid>
                  
                  <!-- Selected Teachers List -->
                  <ItemsControl Name="SelectedTeachersList" ItemsSource="{Binding SelectedTeachers}" Margin="0,0,0,8">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="{DynamicResource BackgroundTertiaryBrush}" CornerRadius="4" Padding="8,4" Margin="0,2">
                          <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0" Text="{Binding}" VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            <Button Grid.Column="1" Content="×" FontSize="14" FontWeight="Bold"
                                    Background="{DynamicResource TransparentColor}" BorderThickness="0" 
                                    Foreground="{DynamicResource TextPrimaryBrush}" Padding="4,0"
                                    Click="OnRemoveTeacherClick" Tag="{Binding}"
                                    ToolTip.Tip="Remove teacher"/>
                          </Grid>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                  
                  <!-- Teacher Selection ComboBox (initially hidden) -->
                  <ComboBox Name="TeacherBox" ItemsSource="{Binding AvailableTeachers}" 
                            IsVisible="False" SelectionChanged="OnTeacherSelected"/>
                </StackPanel>
              </Grid>
            </Grid>

            <!-- Other Form Fields -->
            <StackPanel Spacing="16">
              <StackPanel>
                <TextBlock Text="Name *" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                <TextBox Name="NameBox" Watermark="Enter full name"/>
              </StackPanel>

              <StackPanel>
                <TextBlock Text="Email" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                <TextBox Name="EmailBox" Watermark="student@example.com"/>
              </StackPanel>

              <StackPanel>
                <TextBlock Text="Enrollment Date" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                <DatePicker Name="EnrollmentPicker"/>
              </StackPanel>
            </StackPanel>
          </StackPanel>

          <!-- Classroom Import Mode -->
          <StackPanel IsVisible="{Binding IsClassroomMode}">
            <!-- Classroom Selection -->
            <StackPanel Spacing="16">
              <StackPanel>
                
                <!-- Loading State -->
                <StackPanel IsVisible="{Binding IsLoadingClassrooms}" HorizontalAlignment="Center" Margin="0,20">
                  <TextBlock Text="Loading classrooms..." FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                </StackPanel>
                
                <!-- Classroom Cards Grid -->
                <ScrollViewer IsVisible="{Binding !IsLoadingClassrooms}" 
                             VerticalScrollBarVisibility="Auto" 
                             MaxHeight="200"
                             HorizontalScrollBarVisibility="Disabled">
                  <ItemsControl ItemsSource="{Binding AvailableClassrooms}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <UniformGrid Columns="2" Margin="0,0,0,8"/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Background="{DynamicResource BackgroundPrimaryBrush}" 
                                BorderBrush="{DynamicResource BlackBrush}" 
                                BorderThickness="1" 
                                CornerRadius="8" 
                                Margin="4"
                                Padding="16,12"
                                Cursor="Hand"
                                PointerPressed="OnClassroomCardPressed">
                          <Grid RowDefinitions="Auto,Auto">
                            <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                              <TextBlock Grid.Column="0" Text="{Binding Name}" 
                                         FontSize="14" 
                                         FontWeight="SemiBold" 
                                         Foreground="{DynamicResource TextPrimaryBrush}"
                                         TextWrapping="Wrap"/>
                              <TextBlock Grid.Column="1" Text="{Binding Section}" 
                                         FontSize="11" 
                                         Foreground="{DynamicResource TextSecondaryBrush}"
                                         HorizontalAlignment="Right"
                                         IsVisible="{Binding Section, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            </Grid>
                            <TextBlock Grid.Row="1" Text="{Binding Description}" 
                                       FontSize="10" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       TextWrapping="Wrap"
                                       MaxHeight="32"
                                       TextTrimming="CharacterEllipsis"
                                       IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                       Margin="0,2,0,0"/>
                          </Grid>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </ScrollViewer>
                
                <!-- No Classrooms Message -->
                <StackPanel IsVisible="{Binding !IsLoadingClassrooms}" 
                           HorizontalAlignment="Center" 
                           Margin="0,20">
                  <StackPanel IsVisible="{Binding AvailableClassrooms.Count, Converter={x:Static views:ComparisonConverter.Instance}, ConverterParameter='==,0'}">
                    <TextBlock Text="No classrooms available" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                    <TextBlock Text="Make sure you're logged in with Google and have access to Google Classroom" 
                               FontSize="10" 
                               Foreground="{DynamicResource TextSecondaryBrush}" 
                               HorizontalAlignment="Center" 
                               TextWrapping="Wrap"
                               Margin="0,4,0,0"/>
                  </StackPanel>
                </StackPanel>
              </StackPanel>

              <!-- Students List -->
              <StackPanel>
                <Grid ColumnDefinitions="*,Auto,Auto">
                  <TextBlock Grid.Column="0" Text="Select Students" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,6"/>
                  <Button Grid.Column="1" Content="Select All" Classes="secondary" FontSize="11" 
                          Padding="8,4" Margin="0,0,8,6" Click="OnSelectAllStudentsClick"/>
                  <Button Grid.Column="2" Content="Deselect All" Classes="secondary" FontSize="11" 
                          Padding="8,4" Margin="0,0,0,6" Click="OnDeselectAllStudentsClick"/>
                </Grid>
                
                <Border Background="{DynamicResource BackgroundSecondaryBrush}" CornerRadius="6" Padding="12" MaxHeight="300">
                  <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding ClassroomStudents}">
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Border Background="{DynamicResource BackgroundTertiaryBrush}" CornerRadius="4" Padding="8" Margin="0,2">
                            <Grid ColumnDefinitions="Auto,*,Auto">
                              <CheckBox Grid.Column="0" IsChecked="{Binding IsSelected}" Margin="0,0,12,0"/>
                              <StackPanel Grid.Column="1">
                                <TextBlock Text="{Binding Name}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBlock Text="{Binding Email}" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                              </StackPanel>
                              <Border Grid.Column="2" Width="32" Height="32" CornerRadius="16" ClipToBounds="True">
                                <Image Source="{Binding ProfilePhotoUrl, Converter={StaticResource UniversalImageConverter}}"
                                       IsVisible="{Binding HasProfilePhoto}"/>
                              </Border>
                            </Grid>
                          </Border>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </ScrollViewer>
                </Border>
                <TextBlock Text="Loading students..." IsVisible="{Binding IsLoadingStudents}" 
                           FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,4,0,0"/>
              </StackPanel>
            </StackPanel>
          </StackPanel>
        </StackPanel>
      </ScrollViewer>

      <!-- Footer -->
      <StackPanel Grid.Row="3" Margin="0,24,0,0">
        <Rectangle Height="1" Fill="{DynamicResource BlackBrush}" Margin="0,0,0,16"/>
        <Grid ColumnDefinitions="*,Auto,Auto">
          <TextBlock Grid.Column="0" Name="ValidationText" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" FontSize="13"/>
          <Button Grid.Column="1" Content="Cancel" Classes="secondary" Click="OnCancelClick" Margin="0,0,12,0"/>
          <Button Grid.Column="2" Content="Add Student" Classes="primary" Click="OnAddClick" Name="PrimaryButton"/>
        </Grid>
      </StackPanel>
    </Grid>
  </Border>
</Window>


